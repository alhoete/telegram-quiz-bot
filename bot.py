# bot.py
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ParseMode
from telegram.ext import Updater, CallbackContext, CallbackQueryHandler, CommandHandler
from typing import Dict

# ==== الأسئلة ====
# كل عنصر: {"q": "نص السؤال", "options": ["A","B","C","D"], "answer": 0-based index of correct option}
QUESTIONS = [
{"q":"كلمة \"أردن\" في أصلها الآرامي تعني:","options":["الأرض الخصبة","القوة والانحدار","الأرض المستوية","الضفة المرتفعة"], "answer":1},
{"q":"أطلقت تسمية الأردن قبل الميلاد على المنطقة المحاذية لـ:","options":["نهر الفرات","نهر الأردن","نهر الزرقاء","البحر الميت"], "answer":1},
{"q":"بعد الفتح الإسلامي أصبحت المنطقة الشرقية والغربية للنهر تُعرف باسم:","options":["جند دمشق","جند الأردن","جند فلسطين","جند حوران"], "answer":1},
{"q":"امتد جند الأردن شرقاً إلى:","options":["سواحل المتوسط","أطراف البادية الشامية","وادي عربة","جبال الجليل"], "answer":1},
{"q":"امتد جند الأردن غرباً حتى:","options":["وادي عربة","سواحل البحر المتوسط","خليج العقبة","صحراء النقب"], "answer":1},
{"q":"من مدن جند الأردن التاريخية:","options":["الكرك","بيسان","معان","جرش فقط"], "answer":1},
{"q":"مركز جند الأردن في العصور الإسلامية كان في:","options":["جرش","طبريا","بيسان","القدس"], "answer":1},
{"q":"من المدن التي ضمها جند الأردن شرق النهر:","options":["بيت ساحور","جدارا","صفد","طبريا"], "answer":1},
{"q":"من المدن التي ضمها غرب النهر:","options":["عكا","السلط","عمان","الزرقاء"], "answer":0},
{"q":"امتدت حدود الأردن التاريخية جنوباً حتى:","options":["يافا","غزة","جرش","مادبا"], "answer":0},
{"q":"تأسست إمارة شرق الأردن سنة:","options":["1919","1921","1925","1930"], "answer":1},
{"q":"مؤسس الإمارة هو:","options":["الشريف حسين","الملك الحسين","الملك عبدالله الأول","الملك طلال"], "answer":2},
{"q":"جاءت الإمارة امتداداً لنتائج:","options":["حرب البلقان","الثورة العربية الكبرى","حملة نابليون","الحرب العالمية الثانية"], "answer":1},
{"q":"أُعلن استقلال الأردن التام سنة:","options":["1946","1952","1950","1939"], "answer":0},
{"q":"أُنجز الدستور الأردني الحديث سنة:","options":["1946","1952","1962","1970"], "answer":1},
{"q":"ينص الدستور على أن نظام الحكم في الأردن هو:","options":["جمهوري برلماني","ملكي نيابي وراثي","ملكي مطلق","اتحادي برلماني"], "answer":1},
{"q":"تنص المادة 24 من الدستور على أن الأمة مصدر السلطات، وهذا يعبر عن:","options":["ديمقراطية مباشرة","سيادة الشعب","فصل السلطات","إشراف الملك على السلطة القضائية"], "answer":1},
{"q":"يتكون البرلمان الأردني من:","options":["مجلس واحد","مجلسين (نواب وأعيان)","مجلس الوزراء فقط","مجلس الملك الخاص"], "answer":1},
{"q":"الحد الأعلى لعدد أعضاء مجلس الأعيان هو:","options":["نصف عدد النواب","ضعف عدد النواب","ثلث النواب","ربع النواب"], "answer":0},
{"q":"السلطة القضائية في الأردن مستقلة، وهذا يعني:","options":["تبعيتها للسلطة التشريعية","عدم خضوعها لغير القانون","إدارة القضاة من الحكومة","إشراف النواب على القضاء"], "answer":1},
{"q":"الوصاية الهاشمية على المقدسات في القدس تعتبر:","options":["التزاماً سياسياً حديثاً فقط","مسؤولية تاريخية ودينية وقانونية","عملاً تطوعياً","دوراً مؤقتاً"], "answer":1},
{"q":"أول مراحل الإعمار الهاشمي للمسجد الأقصى بدأت في عهد:","options":["الملك عبدالله الثاني","الملك طلال","الملك الحسين","الملك عبدالله الأول"], "answer":3},
{"q":"الإعمار الهاشمي الثاني بدأ سنة:","options":["1954","1964","1975","1989"], "answer":0},
{"q":"في الإعمار الثاني تمت إعادة كسوة قبة الصخرة بـ:","options":["الرخام الأبيض","الفسيفساء","الألمنيوم الأصفر","النحاس الأحمر"], "answer":2},
{"q":"مشاركة الملك الحسين في إخماد حريق كنيسة القيامة كانت عام:","options":["1948","1949","1950","1952"], "answer":1},
{"q":"أحد أهم أسباب إلغاء المعاهدة البريطانية كان:","options":["التحالف مع إسرائيل","الدعم المالي العربي","تغيير النظام السياسي","الضغوط الداخلية"], "answer":1},
{"q":"اتفاقية التضامن العربي التي دعمت الأردن مالياً كانت عام:","options":["1957","1950","1946","1963"], "answer":0},
{"q":"انضم الأردن للأمم المتحدة كعضو كامل عام:","options":["1946","1955","1967","1974"], "answer":1},
{"q":"الاتحاد العربي الهاشمي كان بين الأردن و:","options":["السعودية","سوريا","العراق","مصر"], "answer":2},
{"q":"الجمهورية العربية المتحدة أعلنت عداءها للأردن بعد تأسيسها سنة:","options":["1958","1962","1950","1949"], "answer":0},
{"q":"شارك الأردن في التحالف الدولي ضد \"داعش\" عام:","options":["2010","2014","2017","2007"], "answer":1},
{"q":"أهم ثابت في السياسة الأردنية تجاه القدس هو:","options":["تقاسم الإدارة","التخلي عن الوصاية","حماية المقدسات الإسلامية والمسيحية","حياد ديني كامل"], "answer":2},
{"q":"يصف الملك عبدالله الثاني الدولة المدنية بأنها دولة:","options":["حزب واحد","سلطة واحدة","قانون ومؤسسات","أعراف قبلية"], "answer":2},
{"q":"من قيم الدولة المدنية:","options":["إلغاء التعددية","احترام الحقوق والحريات","عدم الفصل بين السلطات","سيطرة فئة واحدة"], "answer":1},
{"q":"من ملامح الهوية الوطنية الأردنية:","options":["الانغلاق الثقافي","العروبة والإسلام والانفتاح","إلغاء الأقليات","نفي التنوع الاجتماعي"], "answer":1},
{"q":"من عناصر الهوية الوطنية الأردنية:","options":["رفض التعدد الثقافي","الانتماء العربي الإسلامي","الانعزال عن العالم","الارتباط القبلي فقط"], "answer":1},
{"q":"أكد الدستور الأردني أن اللغة الرسمية للدولة هي:","options":["الإنجليزية","التركية","العربية","العبرية"], "answer":2},
{"q":"يتجلى الدور الهاشمي تاريخياً في رعاية:","options":["الحدود فقط","المقدسات الإسلامية والمسيحية","التجارة الدولية","الدبلوماسية الأوروبية"], "answer":1},
{"q":"ركز الهاشميون في الإعمار الأول للمقدسات على:","options":["بناء مواقع سياحية","ترميم المسجد الأقصى","إنشاء متاحف جديدة","شق طرق جديدة"], "answer":1},
{"q":"امتاز الإعمار الهاشمي الثاني بأنه:","options":["إشراف أوروبي","إعادة بناء المسجد الأموي","إعادة كسوة قبة الصخرة بالألمنيوم الأصفر","ترميم سور عكا"], "answer":2},
{"q":"الإعمار الهاشمي الثالث تركز على:","options":["الأقصى فقط","القبة وحدها","ترميم الأبنية المحيطة وتسقيف المصلى","مشروع تجاري في القدس"], "answer":2},
{"q":"من أبرز مواقف الأردن تجاه القضية الفلسطينية:","options":["رفض حل الدولتين","الدعم الكامل للمقدسات في القدس","عدم تدخل سياسي","تأييد الاحتلال"], "answer":1},
{"q":"في العلاقات الخارجية يتمسك الأردن بمبدأ:","options":["التدخل في شؤون الدول","العزلة الكاملة","عدم التدخل المتبادل والاحترام","فرض السياسات الإقليمية"], "answer":2},
{"q":"الركن الأساسي للأمن الوطني الأردني هو:","options":["الصناعة فقط","المؤسسة العسكرية","القطاع الخاص","المجتمع المدني"], "answer":1},
{"q":"من أولويات الأمن الوطني الداخلية:","options":["التخلي عن حكم القانون","ضعف الجبهة الداخلية","التماسك والوحدة الوطنية","وقف التعليم"], "answer":2},
{"q":"من أولويات الأمن الوطني الخارجية:","options":["قطع العلاقات العربية","دعم التطرف","إقامة الدولة الفلسطينية المستقلة","الابتعاد عن المجتمع الدولي"], "answer":2},
{"q":"الأمن السياسي في الأردن يقوم على:","options":["حكومة عسكرية","مشاركة المواطنين في اتخاذ القرار","غياب البرلمان","هيمنة حزب واحد"], "answer":1},
{"q":"الأمن الاقتصادي يتأثر في الأردن بسبب:","options":["غياب الثروات تماماً","ضعف الموارد وقلة مصادر المياه","فائض الإنتاج الزراعي","اكتفاء ذاتي كامل"], "answer":1},
{"q":"من مظاهر التهديد الاجتماعي للأمن الوطني:","options":["التعاون الأهلي","التطرف","مؤسسات المجتمع المدني","النقابات المهنية"], "answer":1},
{"q":"أحد التحديات الاقتصادية الرئيسة هو:","options":["زيادة الهجرة الداخلية","البطالة المرتفعة","زيادة مخزون النفط","ارتفاع الأمطار"], "answer":1},
{"q":"تشير البطالة إلى حالة:","options":["عدم القدرة والرغبة في العمل","القدرة على العمل دون توفر وظيفة مناسبة","رفض العمل من الأغنياء","العمل بدون أجر"], "answer":1},
]

# ==== نهاية الأسئلة ====

# Data structure لتتبع حالة كل مستخدم: {chat_id: {"index": int, "score": int}}
user_states: Dict[int, Dict[str, int]] = {}

def build_options_keyboard(q_index: int):
    q = QUESTIONS[q_index]
    buttons = []
    labels = ["أ", "ب", "ج", "د"]
    for i, opt in enumerate(q["options"]):
        text = f"{labels[i]}) {opt}"
        # Callback data يحمل رقم السؤال ورقم الاختيار
        buttons.append([InlineKeyboardButton(text, callback_data=f"ans|{q_index}|{i}")])
    return InlineKeyboardMarkup(buttons)

def send_question(context: CallbackContext, chat_id: int):
    state = user_states.get(chat_id)
    if state is None:
        return
    idx = state["index"]
    if idx >= len(QUESTIONS):
        # انتهى الاختبار
        score = state["score"]
        total = len(QUESTIONS)
        context.bot.send_message(chat_id=chat_id,
                                 text=f"انتهى الاختبار! نتيجتك: *{score}* من *{total}*.\n\nاكتب /start لإعادة الاختبار.",
                                 parse_mode=ParseMode.MARKDOWN)
        # إزالة حالة المستخدم
        user_states.pop(chat_id, None)
        return

    q = QUESTIONS[idx]
    header = f"السؤال {idx+1}/{len(QUESTIONS)}:\n{q['q']}"
    context.bot.send_message(chat_id=chat_id, text=header, reply_markup=build_options_keyboard(idx))

def start(update: Update, context: CallbackContext):
    chat_id = update.effective_chat.id
    user_states[chat_id] = {"index": 0, "score": 0}
    context.bot.send_message(chat_id=chat_id, text="بدأنا الاختبار. حظاً موفقاً! كل ما تجاوب يجيك السؤال اللي بعده.")
    send_question(context, chat_id)

def callback_answer(update: Update, context: CallbackContext):
    query = update.callback_query
    chat_id = query.message.chat.id
    data = query.data  # format: ans|q_index|option_index
    try:
        _, q_index_str, opt_index_str = data.split("|")
        q_index = int(q_index_str)
        opt_index = int(opt_index_str)
    except Exception:
        query.answer(text="خطأ في البيانات.", show_alert=True)
        return

    # منع تكرار الضغط: نلغّي أزرار الرسالة
    try:
        query.edit_message_reply_markup(reply_markup=None)
    except Exception:
        pass

    # تحقق أن هذه هي الحالة المتوقعة
    state = user_states.get(chat_id)
    if state is None:
        query.answer(text="لم يبدأ الاختبار. اكتب /start", show_alert=True)
        return

    current_idx = state["index"]
    # إذا المستخدم ضغط على سؤال قديم (أو تلاعب)، تجاهل أو أنبه
    if q_index != current_idx:
        query.answer(text="هذا ليس السؤال الحالي.", show_alert=True)
        return

    correct_idx = QUESTIONS[q_index]["answer"]
    labels = ["أ", "ب", "ج", "د"]
    if opt_index == correct_idx:
        state["score"] += 1
        feedback = f"✅ إجابة صحيحة! ({labels[opt_index]})"
    else:
        correct_text = QUESTIONS[q_index]["options"][correct_idx]
        feedback = f"❌ خطأ. الإجابة الصحيحة: {labels[correct_idx]}) {correct_text}"

    # أجب على callback (يعطي إشعار سريع للمستخدم)
    query.answer()

    # أرسل نتيجة السؤال الحالي
    context.bot.send_message(chat_id=chat_id, text=feedback)

    # انتقل للسؤال التالي
    state["index"] += 1
    # ارسال السؤال التالي بعد رد المستخدم
    send_question(context, chat_id)

def help_cmd(update: Update, context: CallbackContext):
    update.message.reply_text("اكتب /start لبدء الاختبار. بعد كل إجابة يرسل البوت السؤال التالي تلقائياً.")

def main():
    token = os.environ.get("TOKEN")
    if not token:
        print("ERROR: TOKEN environment variable not set.")
        return

    updater = Updater(token, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("help", help_cmd))
    dp.add_handler(CallbackQueryHandler(callback_answer, pattern=r"^ans\|"))

    print("Bot is starting...")
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
